<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>DropOne ‚Äî Plateforme Dropshipping Professionnelle</title>
<meta name="description" content="Cr√©ez votre boutique e-commerce en dropshipping. Produits tendance, paiements s√©curis√©s, livraison mondiale.">
<meta name="theme-color" content="#0c0f1a">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="manifest" href="/manifest.json">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;1,9..40,400&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<style>
:root {
  --bg: #0c0f1a;
  --bg2: #131829;
  --card: #181d30;
  --card-hover: #1e2440;
  --border: #252d48;
  --border-light: #2a3355;
  --accent: #6366f1;
  --accent-hover: #818cf8;
  --accent-bg: rgba(99,102,241,0.1);
  --accent-border: rgba(99,102,241,0.25);
  --green: #10b981;
  --green-bg: rgba(16,185,129,0.1);
  --green-border: rgba(16,185,129,0.25);
  --red: #ef4444;
  --red-bg: rgba(239,68,68,0.1);
  --orange: #f59e0b;
  --orange-bg: rgba(245,158,11,0.1);
  --blue: #3b82f6;
  --text: #e8eaf0;
  --text2: #8b92ab;
  --text3: #565e7a;
  --radius: 12px;
  --radius-sm: 8px;
  --safe-bottom: env(safe-area-inset-bottom, 0px);
  --shadow: 0 1px 3px rgba(0,0,0,0.3), 0 4px 12px rgba(0,0,0,0.2);
  --shadow-lg: 0 4px 20px rgba(0,0,0,0.4);
}

* { margin:0; padding:0; box-sizing:border-box; }
html, body { height:100%; overflow:hidden; }
body {
  font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
  background: var(--bg); color: var(--text);
  -webkit-font-smoothing: antialiased;
  -webkit-tap-highlight-color: transparent;
  font-size: 15px;
  line-height: 1.5;
}

/* ===== SCROLLBAR ===== */
::-webkit-scrollbar { width: 4px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }

/* ===== APP SHELL ===== */
.app { height:100%; display:flex; flex-direction:column; display:none; }
.app-content {
  flex:1; overflow-y:auto; overflow-x:hidden;
  -webkit-overflow-scrolling:touch;
  padding-bottom: calc(70px + var(--safe-bottom));
}
.screen { display:none; }
.screen.active { display:block; }

/* ===== TOP BAR ===== */
.topbar {
  display:flex; align-items:center; justify-content:space-between;
  padding: 12px 16px;
  background: rgba(12,15,26,0.85);
  backdrop-filter: blur(20px);
  border-bottom: 1px solid var(--border);
  position: sticky; top: 0; z-index: 100;
}
.topbar-brand {
  display:flex; align-items:center; gap:8px;
}
.topbar-logo {
  font-size: 1.15rem; font-weight: 700;
  background: linear-gradient(135deg, #6366f1, #a78bfa);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  letter-spacing: -0.5px;
}
.topbar-badge {
  font-size: 0.6rem; font-weight: 600;
  padding: 2px 6px; border-radius: 4px;
  background: var(--accent-bg); color: var(--accent);
  border: 1px solid var(--accent-border);
}
.topbar-user {
  display:flex; align-items:center; gap:10px;
}
.topbar-avatar {
  width: 32px; height: 32px; border-radius: 50%;
  background: var(--card); border: 2px solid var(--border);
  display:flex; align-items:center; justify-content:center;
  cursor:pointer; overflow: hidden;
  transition: border-color 0.2s;
}
.topbar-avatar:hover { border-color: var(--accent); }
.topbar-avatar img { width:100%; height:100%; object-fit:cover; border-radius:50%; }

/* ===== TAB BAR ===== */
.tabbar {
  display:flex;
  background: rgba(12,15,26,0.92);
  backdrop-filter: blur(20px);
  border-top: 1px solid var(--border);
  padding: 6px 4px calc(6px + var(--safe-bottom));
  position: fixed; bottom: 0; left: 0; right: 0;
  z-index: 100;
}
.tab {
  flex:1; display:flex; flex-direction:column; align-items:center;
  gap: 2px; padding: 6px 2px;
  background:none; border:none; color:var(--text3);
  font-family:inherit; font-size:0.65rem; font-weight:500;
  cursor:pointer; transition: color 0.2s;
  position: relative;
}
.tab.active { color: var(--accent); }
.tab-icon { font-size: 1.15rem; line-height: 1; }
.tab-dot {
  position:absolute; top:4px; right:calc(50% - 16px);
  width:6px; height:6px; border-radius:50%;
  background:var(--red); display:none;
}

/* ===== LOGIN ===== */
.login-screen {
  height:100%; display:flex; flex-direction:column;
  align-items:center; justify-content:center;
  padding: 32px 24px;
  background: var(--bg);
  position: relative; overflow: hidden;
}
.login-screen::before {
  content:''; position:absolute; top:-30%; left:-20%;
  width:140%; height:60%;
  background: radial-gradient(ellipse, rgba(99,102,241,0.08) 0%, transparent 70%);
  pointer-events:none;
}
.login-screen.hidden { display:none; }
.login-icon {
  font-size: 2.8rem; margin-bottom: 16px;
  filter: drop-shadow(0 4px 12px rgba(99,102,241,0.3));
}
.login-brand {
  font-size: 2rem; font-weight: 700;
  background: linear-gradient(135deg, #e8eaf0, #8b92ab);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  margin-bottom: 8px; letter-spacing: -1px;
}
.login-tagline {
  font-size: 0.9rem; color: var(--text2);
  text-align:center; max-width: 320px;
  line-height: 1.5; margin-bottom: 32px;
}
.login-features {
  display:flex; flex-direction:column; gap:12px;
  margin-bottom:32px; width:100%; max-width:340px;
}
.login-feature {
  display:flex; align-items:center; gap:12px;
  padding: 12px 16px;
  background: var(--card); border-radius: var(--radius-sm);
  border: 1px solid var(--border);
}
.login-feature-icon { font-size: 1.2rem; flex-shrink:0; }
.login-feature-text { font-size: 0.82rem; color: var(--text2); }
.login-feature-text strong { color: var(--text); font-weight: 600; }

.btn-google {
  display:flex; align-items:center; justify-content:center; gap:10px;
  width:100%; max-width:340px;
  padding: 14px 20px;
  background: #fff; color: #1f1f1f;
  border:none; border-radius: var(--radius-sm);
  font-family:inherit; font-size:0.92rem; font-weight:600;
  cursor:pointer; transition: transform 0.15s, box-shadow 0.15s;
  box-shadow: var(--shadow);
  margin-bottom: 10px;
}
.btn-google:active { transform: scale(0.98); }
.btn-google svg { width:20px; height:20px; }

.btn-email {
  display:flex; align-items:center; justify-content:center; gap:8px;
  width:100%; max-width:340px;
  padding: 14px 20px;
  background: transparent; color: var(--text2);
  border: 1px solid var(--border); border-radius: var(--radius-sm);
  font-family:inherit; font-size:0.88rem; font-weight:500;
  cursor:pointer; transition: border-color 0.2s, color 0.2s;
}
.btn-email:hover { border-color: var(--text3); color: var(--text); }

.login-legal {
  font-size: 0.7rem; color: var(--text3);
  text-align: center; margin-top: 20px;
  max-width: 300px; line-height: 1.4;
}
.login-legal a { color: var(--text2); text-decoration: underline; }

/* ===== SECTION HEADERS ===== */
.section-header {
  padding: 20px 16px 12px;
}
.section-title {
  font-size: 1.3rem; font-weight: 700;
  letter-spacing: -0.5px;
}
.section-subtitle {
  font-size: 0.82rem; color: var(--text2);
  margin-top: 2px;
}

/* ===== SEARCH ===== */
.search-bar {
  margin: 0 16px 12px; position: relative;
}
.search-bar input {
  width:100%; padding: 11px 12px 11px 38px;
  background: var(--card); border: 1px solid var(--border);
  border-radius: var(--radius-sm); color: var(--text);
  font-family:inherit; font-size:0.88rem;
  outline:none; transition: border-color 0.2s;
}
.search-bar input::placeholder { color: var(--text3); }
.search-bar input:focus { border-color: var(--accent); }
.search-icon {
  position:absolute; left:12px; top:50%; transform:translateY(-50%);
  font-size:0.85rem; color: var(--text3); pointer-events:none;
}

/* ===== CATEGORY PILLS ===== */
.cat-scroll {
  display:flex; gap:6px; padding: 0 16px 14px;
  overflow-x:auto; scrollbar-width:none;
}
.cat-scroll::-webkit-scrollbar { display:none; }
.cat-pill {
  flex-shrink:0; padding: 6px 14px;
  background: var(--card); border: 1px solid var(--border);
  border-radius: 20px; color: var(--text2);
  font-family:inherit; font-size:0.78rem; font-weight:500;
  cursor:pointer; transition: all 0.2s; white-space:nowrap;
}
.cat-pill.active, .cat-pill:active {
  background: var(--accent-bg); color: var(--accent);
  border-color: var(--accent-border);
}

/* ===== PRODUCT GRID ===== */
.product-grid {
  display:grid; grid-template-columns: repeat(2, 1fr);
  gap:10px; padding: 0 16px 20px;
}
.product-card {
  background: var(--card); border-radius: var(--radius);
  border: 1px solid var(--border); overflow:hidden;
  cursor:pointer; transition: transform 0.15s, border-color 0.2s;
}
.product-card:active { transform: scale(0.97); }
.product-card:hover { border-color: var(--border-light); }
.product-img {
  width:100%; aspect-ratio:1; object-fit:cover;
  background: var(--bg2);
}
.product-info { padding: 10px 12px 12px; }
.product-name {
  font-size: 0.82rem; font-weight: 600;
  line-height: 1.3; margin-bottom: 4px;
  display: -webkit-box; -webkit-line-clamp: 2;
  -webkit-box-orient: vertical; overflow: hidden;
}
.product-price {
  font-size: 0.95rem; font-weight: 700;
  color: var(--green);
}
.product-margin {
  font-size: 0.7rem; color: var(--text3);
  margin-top: 2px;
}
.product-tags {
  display:flex; gap:4px; margin-top:6px; flex-wrap:wrap;
}
.product-tag {
  font-size: 0.62rem; padding: 2px 6px;
  background: var(--accent-bg); color: var(--accent);
  border-radius: 4px; font-weight: 500;
}

/* ===== MODALS ===== */
.modal-overlay {
  position:fixed; inset:0; background:rgba(0,0,0,0.7);
  backdrop-filter:blur(4px);
  z-index:200; display:none;
  align-items:flex-end; justify-content:center;
}
.modal-overlay.open { display:flex; }
.modal-sheet {
  background: var(--bg2); border-radius: 20px 20px 0 0;
  width:100%; max-width:500px;
  max-height: 92vh; overflow-y:auto;
  padding: 8px 0 calc(20px + var(--safe-bottom));
  animation: slideUp 0.3s ease-out;
}
@keyframes slideUp {
  from { transform: translateY(100%); }
  to { transform: translateY(0); }
}
.modal-handle {
  width:36px; height:4px; background:var(--border);
  border-radius:4px; margin: 6px auto 16px;
}

/* ===== PRODUCT DETAIL ===== */
.detail-img {
  width:100%; aspect-ratio:4/3; object-fit:cover;
  border-radius: 0 0 var(--radius) var(--radius);
}
.detail-body { padding: 20px; }
.detail-name {
  font-size:1.2rem; font-weight:700;
  letter-spacing:-0.3px; margin-bottom:6px;
}
.detail-desc {
  font-size:0.85rem; color:var(--text2);
  margin-bottom:16px; line-height:1.5;
}
.detail-stats {
  display:grid; grid-template-columns:repeat(3,1fr); gap:8px;
  margin-bottom:20px;
}
.detail-stat {
  background:var(--card); padding:12px;
  border-radius:var(--radius-sm); text-align:center;
  border:1px solid var(--border);
}
.detail-stat-value { font-size:1rem; font-weight:700; }
.detail-stat-label { font-size:0.68rem; color:var(--text3); margin-top:2px; }

/* Price Slider */
.price-section {
  background:var(--card); padding:16px;
  border-radius:var(--radius); border:1px solid var(--border);
  margin-bottom:16px;
}
.price-row {
  display:flex; justify-content:space-between; align-items:center;
  margin-bottom:8px;
}
.price-label { font-size:0.8rem; color:var(--text2); }
.price-value { font-size:1.3rem; font-weight:700; color:var(--green); }
.price-slider {
  width:100%; -webkit-appearance:none; appearance:none;
  height:6px; border-radius:3px;
  background: linear-gradient(to right, var(--accent), var(--green));
  outline:none; margin:8px 0;
}
.price-slider::-webkit-slider-thumb {
  -webkit-appearance:none; width:22px; height:22px;
  border-radius:50%; background:#fff;
  box-shadow: 0 2px 8px rgba(0,0,0,0.3);
  cursor:pointer;
}
.margin-info {
  display:flex; justify-content:space-between;
  font-size:0.78rem; color:var(--text3);
}

/* Launch Button */
.btn-launch {
  width:100%; padding:15px;
  background: linear-gradient(135deg, var(--accent), #818cf8);
  color:#fff; border:none; border-radius:var(--radius-sm);
  font-family:inherit; font-size:1rem; font-weight:700;
  cursor:pointer; transition: transform 0.15s, opacity 0.15s;
  box-shadow: 0 4px 16px rgba(99,102,241,0.3);
}
.btn-launch:active { transform:scale(0.98); opacity:0.9; }
.btn-launch:disabled {
  opacity:0.5; cursor:not-allowed; transform:none;
}

/* ===== STORES LIST ===== */
.store-card {
  background:var(--card); border-radius:var(--radius);
  border:1px solid var(--border); padding:16px;
  margin: 0 16px 10px;
  transition: border-color 0.2s;
}
.store-card:hover { border-color:var(--border-light); }
.store-header {
  display:flex; justify-content:space-between; align-items:flex-start;
  margin-bottom:10px;
}
.store-name { font-size:0.95rem; font-weight:700; }
.store-status {
  font-size:0.68rem; padding:3px 8px; border-radius:4px;
  font-weight:600;
}
.store-status.active { background:var(--green-bg); color:var(--green); }
.store-status.inactive { background:var(--red-bg); color:var(--red); }
.store-meta {
  font-size:0.78rem; color:var(--text2);
  margin-bottom:10px;
}
.store-stats {
  display:flex; gap:16px; font-size:0.8rem;
}
.store-stat-num { font-weight:700; }
.store-stat-label { color:var(--text3); margin-left:3px; }
.store-actions {
  display:flex; gap:8px; margin-top:12px;
}
.btn-sm {
  padding:7px 14px; border-radius:var(--radius-sm);
  font-family:inherit; font-size:0.78rem; font-weight:600;
  cursor:pointer; border:1px solid var(--border);
  background:var(--bg2); color:var(--text2);
  transition: all 0.2s;
}
.btn-sm:hover { border-color:var(--text3); color:var(--text); }
.btn-sm.primary {
  background:var(--accent); border-color:var(--accent);
  color:#fff;
}

/* ===== ORDERS ===== */
.order-card {
  background:var(--card); border-radius:var(--radius);
  border:1px solid var(--border); padding:14px 16px;
  margin:0 16px 8px;
}
.order-top {
  display:flex; justify-content:space-between; align-items:center;
  margin-bottom:6px;
}
.order-id { font-size:0.82rem; font-weight:600; font-family:monospace; }
.order-status {
  font-size:0.68rem; padding:3px 8px; border-radius:4px;
  font-weight:600;
}
.order-status.pending { background:var(--orange-bg); color:var(--orange); }
.order-status.shipped { background:var(--accent-bg); color:var(--accent); }
.order-status.delivered { background:var(--green-bg); color:var(--green); }
.order-details {
  font-size:0.78rem; color:var(--text2);
}
.order-amount {
  font-size:0.9rem; font-weight:700; color:var(--green);
  margin-top:6px;
}

/* ===== PROFILE ===== */
.profile-card {
  background:var(--card); border-radius:var(--radius);
  border:1px solid var(--border); padding:20px;
  margin:0 16px 10px;
}
.balance-card {
  background: linear-gradient(135deg, #1a1040 0%, #251650 50%, #1a1040 100%);
  border-radius:var(--radius); padding:24px;
  margin:0 16px 10px;
  border:1px solid rgba(99,102,241,0.2);
  position:relative; overflow:hidden;
}
.balance-card::before {
  content:''; position:absolute; top:-50%; right:-30%;
  width:200px; height:200px;
  background: radial-gradient(circle, rgba(99,102,241,0.15), transparent 70%);
  pointer-events:none;
}
.balance-label {
  font-size:0.78rem; color:var(--text2); margin-bottom:4px;
}
.balance-amount {
  font-size:2.2rem; font-weight:700;
  background: linear-gradient(135deg, #e8eaf0, #a78bfa);
  -webkit-background-clip:text; -webkit-text-fill-color:transparent;
}
.balance-row {
  display:flex; justify-content:space-between;
  margin-top:14px; font-size:0.8rem; color:var(--text2);
}
.btn-withdraw {
  width:100%; margin-top:16px; padding:12px;
  background: rgba(99,102,241,0.15);
  border:1px solid rgba(99,102,241,0.3);
  border-radius:var(--radius-sm);
  color:#a78bfa; font-family:inherit;
  font-size:0.88rem; font-weight:600;
  cursor:pointer; transition:all 0.2s;
}
.btn-withdraw:hover {
  background:rgba(99,102,241,0.25);
}

/* Payment method cards */
.pay-method {
  display:flex; align-items:center; justify-content:space-between;
  padding:14px; background:var(--bg);
  border-radius:var(--radius-sm); margin-bottom:8px;
}
.pay-method-info { display:flex; align-items:center; gap:10px; }
.pay-method-icon {
  width:36px; height:36px; border-radius:8px;
  display:flex; align-items:center; justify-content:center;
  font-size:1.1rem;
}
.pay-method-name { font-size:0.85rem; font-weight:600; }
.pay-method-status { font-size:0.72rem; color:var(--text3); }
.btn-connect {
  padding:7px 16px; border-radius:var(--radius-sm);
  font-family:inherit; font-size:0.78rem; font-weight:600;
  cursor:pointer; border:none; transition:all 0.2s;
}

/* PayPal input */
.paypal-form {
  display:flex; gap:8px; margin-top:8px;
}
.paypal-form input {
  flex:1; padding:9px 12px;
  background:var(--card); border:1px solid var(--border);
  border-radius:var(--radius-sm); color:var(--text);
  font-family:inherit; font-size:0.85rem;
  outline:none;
}
.paypal-form input:focus { border-color:var(--accent); }
.paypal-form button {
  padding:9px 18px; border-radius:var(--radius-sm);
  background:#ffc439; color:#000; border:none;
  font-family:inherit; font-size:0.82rem; font-weight:700;
  cursor:pointer;
}

/* Payout history */
.payout-item {
  display:flex; justify-content:space-between; align-items:center;
  padding:10px 0; border-bottom:1px solid var(--border);
  font-size:0.82rem;
}
.payout-item:last-child { border-bottom:none; }

/* Logout */
.btn-logout {
  width:100%; padding:13px; margin: 0 16px 20px;
  width: calc(100% - 32px);
  background:var(--card); border:1px solid var(--border);
  border-radius:var(--radius-sm); color:var(--red);
  font-family:inherit; font-size:0.88rem; font-weight:600;
  cursor:pointer; transition:all 0.2s;
}
.btn-logout:hover { border-color:var(--red); background:var(--red-bg); }

/* ===== NETWORK ===== */
.network-card {
  background:var(--card); border-radius:var(--radius);
  border:1px solid var(--border); padding:16px;
  margin:0 16px 10px;
}
.network-card-title {
  font-size:0.85rem; font-weight:700; margin-bottom:12px;
  display:flex; align-items:center; gap:6px;
}
.trend-item {
  display:flex; align-items:center; justify-content:space-between;
  padding:10px 0; border-bottom:1px solid var(--border);
}
.trend-item:last-child { border-bottom:none; }
.trend-rank {
  font-size:0.75rem; font-weight:700; color:var(--accent);
  width:24px;
}
.trend-name { font-size:0.82rem; font-weight:600; flex:1; }
.trend-sales { font-size:0.8rem; font-weight:700; color:var(--green); }

/* ===== SUCCESS OVERLAY ===== */
.success-overlay {
  position:fixed; inset:0; background:rgba(0,0,0,0.85);
  backdrop-filter:blur(8px);
  z-index:300; display:none;
  align-items:center; justify-content:center;
  padding:24px;
}
.success-overlay.open { display:flex; }
.success-card {
  background:var(--card); border-radius:var(--radius);
  border:1px solid var(--green-border);
  padding:32px 24px; text-align:center;
  max-width:400px; width:100%;
  animation: scaleIn 0.3s ease-out;
}
@keyframes scaleIn {
  from { transform:scale(0.9); opacity:0; }
  to { transform:scale(1); opacity:1; }
}
.success-icon { font-size:3rem; margin-bottom:12px; }
.success-title {
  font-size:1.2rem; font-weight:700; margin-bottom:6px;
}
.success-url {
  font-size:0.82rem; color:var(--accent);
  word-break:break-all; margin:12px 0;
  padding:10px; background:var(--bg);
  border-radius:var(--radius-sm); border:1px solid var(--border);
  cursor:pointer;
}
.success-actions {
  display:flex; flex-direction:column; gap:8px; margin-top:16px;
}

/* ===== EMPTY STATES ===== */
.empty-state {
  text-align:center; padding:48px 24px;
  color:var(--text3);
}
.empty-icon { font-size:2.5rem; margin-bottom:12px; }
.empty-text { font-size:0.88rem; }

/* ===== LOADING ===== */
.spinner {
  width:24px; height:24px; border:3px solid var(--border);
  border-top-color:var(--accent); border-radius:50%;
  animation: spin 0.8s linear infinite;
  margin:20px auto;
}
@keyframes spin { to { transform:rotate(360deg); } }

/* ===== ANALYTICS ===== */
.analytics-grid {
  display:grid; grid-template-columns:repeat(2,1fr); gap:8px;
  margin-bottom:12px;
}
.analytics-card {
  background:var(--bg); padding:14px;
  border-radius:var(--radius-sm);
  border:1px solid var(--border);
}
.analytics-value { font-size:1.1rem; font-weight:700; }
.analytics-label { font-size:0.7rem; color:var(--text3); margin-top:2px; }

/* ===== SHARE MODAL ===== */
.share-platforms {
  display:grid; grid-template-columns:repeat(2,1fr); gap:8px;
}
.share-btn {
  display:flex; align-items:center; gap:8px;
  padding:12px; background:var(--card);
  border:1px solid var(--border); border-radius:var(--radius-sm);
  color:var(--text); font-family:inherit; font-size:0.82rem;
  font-weight:600; cursor:pointer; transition:all 0.2s;
}
.share-btn:hover { border-color:var(--text3); }

/* ===== CONTENT MODAL ===== */
.content-tabs {
  display:flex; gap:6px; margin-bottom:16px;
  overflow-x:auto; scrollbar-width:none;
}
.content-tabs::-webkit-scrollbar { display:none; }
.content-tab {
  flex-shrink:0; padding:8px 16px;
  background:var(--card); border:1px solid var(--border);
  border-radius:var(--radius-sm); color:var(--text2);
  font-family:inherit; font-size:0.8rem; font-weight:600;
  cursor:pointer; transition:all 0.2s; white-space:nowrap;
}
.content-tab.active {
  background:var(--accent-bg); color:var(--accent);
  border-color:var(--accent-border);
}
.content-result {
  background:var(--card); border:1px solid var(--border);
  border-radius:var(--radius-sm); padding:16px;
  font-size:0.85rem; line-height:1.6;
  white-space:pre-wrap;
}
.btn-copy {
  display:inline-flex; align-items:center; gap:4px;
  padding:6px 12px; background:var(--accent-bg);
  border:1px solid var(--accent-border);
  border-radius:6px; color:var(--accent);
  font-family:inherit; font-size:0.75rem; font-weight:600;
  cursor:pointer; margin-top:8px;
}

/* ===== RESPONSIVE ===== */
@media (min-width:640px) {
  .product-grid { grid-template-columns:repeat(3,1fr); }
}
@media (min-width:900px) {
  .product-grid { grid-template-columns:repeat(4,1fr); }
}
</style>
</head>
<body>

<!-- ============================================================ -->
<!-- LOGIN SCREEN -->
<!-- ============================================================ -->
<div class="login-screen" id="loginScreen">
  <div class="login-icon">üè™</div>
  <div class="login-brand">DropOne</div>
  <div class="login-tagline">Plateforme de dropshipping professionnelle.<br>Cr√©ez, vendez, encaissez.</div>

  <div class="login-features">
    <div class="login-feature">
      <span class="login-feature-icon">üì¶</span>
      <div class="login-feature-text"><strong>134 produits</strong> pr√™ts √† vendre avec marges 60-85%</div>
    </div>
    <div class="login-feature">
      <span class="login-feature-icon">üí≥</span>
      <div class="login-feature-text"><strong>Paiement int√©gr√©</strong> ‚Äî Stripe & PayPal, encaissez directement</div>
    </div>
    <div class="login-feature">
      <span class="login-feature-icon">üìä</span>
      <div class="login-feature-text"><strong>Analytics & AI</strong> ‚Äî Suivi des ventes, contenu auto-g√©n√©r√©</div>
    </div>
  </div>

  <button class="btn-google" id="btnGoogle" onclick="loginWithGoogle()">
    <svg viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 01-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
    Continuer avec Google
  </button>

  <button class="btn-email" onclick="loginWithEmail()">
    Continuer avec un email
  </button>

  <div class="login-legal">
    En continuant, vous acceptez nos <a href="#">CGU</a> et notre <a href="#">politique de confidentialit√©</a>.
  </div>
</div>

<!-- ============================================================ -->
<!-- MAIN APP -->
<!-- ============================================================ -->
<div class="app" id="mainApp">
  <!-- TOP BAR -->
  <div class="topbar">
    <div class="topbar-brand">
      <div class="topbar-logo">DropOne</div>
      <div class="topbar-badge">PRO</div>
    </div>
    <div class="topbar-user">
      <div class="topbar-avatar" id="topbarAvatar" onclick="switchTab('profile',document.querySelector('.tab:last-child'))">
        <span id="avatarContent">üë§</span>
      </div>
    </div>
  </div>

  <!-- CONTENT -->
  <div class="app-content">

    <!-- ===== EXPLORE ===== -->
    <div class="screen active" id="screen-explore">
      <div class="section-header">
        <div class="section-title">Catalogue</div>
        <div class="section-subtitle">Choisissez un produit et lancez votre boutique</div>
      </div>
      <div class="search-bar">
        <span class="search-icon">üîç</span>
        <input type="text" placeholder="Rechercher un produit..." id="searchInput" oninput="filterProducts()">
      </div>
      <div class="cat-scroll" id="catScroll"></div>
      <div class="product-grid" id="productGrid"></div>
    </div>

    <!-- ===== NETWORK ===== -->
    <div class="screen" id="screen-network">
      <div class="section-header">
        <div class="section-title">R√©seau</div>
        <div class="section-subtitle">Tendances, classement et performances</div>
      </div>
      <div id="networkContent"></div>
    </div>

    <!-- ===== STORES ===== -->
    <div class="screen" id="screen-stores">
      <div class="section-header">
        <div class="section-title">Mes boutiques</div>
        <div class="section-subtitle">G√©rez vos boutiques actives</div>
      </div>
      <div id="storesContent"></div>
    </div>

    <!-- ===== ORDERS ===== -->
    <div class="screen" id="screen-orders">
      <div class="section-header">
        <div class="section-title">Commandes</div>
        <div class="section-subtitle">Suivi de toutes vos ventes</div>
      </div>
      <div id="ordersContent"></div>
    </div>

    <!-- ===== PROFILE ===== -->
    <div class="screen" id="screen-profile">
      <div class="section-header">
        <div class="section-title">Mon compte</div>
      </div>

      <!-- User card -->
      <div class="profile-card" style="text-align:center;">
        <img id="profileAvatar" src="" style="display:none;width:56px;height:56px;border-radius:50%;margin:0 auto 10px;border:2px solid var(--border);">
        <div id="profileName" style="font-size:1.1rem;font-weight:700;margin-bottom:2px;"></div>
        <div id="profileEmail" style="font-size:0.82rem;color:var(--text2);">Non connect√©</div>
        <div id="profileProvider" style="font-size:0.72rem;color:var(--text3);margin-top:4px;"></div>
      </div>

      <!-- Balance -->
      <div class="balance-card">
        <div class="balance-label">Solde disponible</div>
        <div class="balance-amount" id="sellerBalance">‚Ç¨0.00</div>
        <div class="balance-row">
          <span>Total gagn√© <strong id="sellerTotalEarned">‚Ç¨0.00</strong></span>
          <span>Retir√© <strong id="sellerTotalWithdrawn">‚Ç¨0.00</strong></span>
        </div>
        <button class="btn-withdraw" onclick="requestWithdrawal()">
          Retirer mes gains ‚Üí
        </button>
      </div>

      <!-- Payment Methods -->
      <div class="profile-card">
        <div style="font-size:0.88rem;font-weight:700;margin-bottom:14px;">M√©thodes de paiement</div>

        <div class="pay-method">
          <div class="pay-method-info">
            <div class="pay-method-icon" style="background:rgba(99,102,241,0.1);">üí≥</div>
            <div>
              <div class="pay-method-name">Stripe Connect</div>
              <div class="pay-method-status" id="stripeStatus">Non configur√©</div>
            </div>
          </div>
          <button class="btn-connect" id="stripeConnectBtn" onclick="connectStripe()" style="background:var(--accent);color:#fff;">Connecter</button>
        </div>

        <div class="pay-method">
          <div class="pay-method-info">
            <div class="pay-method-icon" style="background:rgba(245,158,11,0.1);">üÖøÔ∏è</div>
            <div>
              <div class="pay-method-name">PayPal</div>
              <div class="pay-method-status" id="paypalStatus">Non configur√©</div>
            </div>
          </div>
        </div>
        <div class="paypal-form">
          <input type="email" id="paypalEmailInput" placeholder="Email PayPal">
          <button onclick="savePaypalEmail()">Enregistrer</button>
        </div>
      </div>

      <!-- Payout History -->
      <div class="profile-card">
        <div style="font-size:0.88rem;font-weight:700;margin-bottom:10px;">Historique des retraits</div>
        <div id="payoutHistory" style="font-size:0.82rem;color:var(--text3);">Aucun retrait pour le moment</div>
      </div>

      <button class="btn-logout" onclick="logout()">Se d√©connecter</button>
    </div>

  </div>

  <!-- TAB BAR -->
  <div class="tabbar">
    <button class="tab active" onclick="switchTab('explore', this)">
      <span class="tab-icon">üîç</span>Catalogue
    </button>
    <button class="tab" onclick="switchTab('network', this)">
      <span class="tab-icon">üìä</span>R√©seau
    </button>
    <button class="tab" onclick="switchTab('stores', this)">
      <span class="tab-icon">üè™</span>Boutiques
    </button>
    <button class="tab" onclick="switchTab('orders', this)" style="position:relative;">
      <span class="tab-icon">üì¶</span>Commandes
      <div class="tab-dot" id="ordersDot"></div>
    </button>
    <button class="tab" onclick="switchTab('profile', this)">
      <span class="tab-icon">üë§</span>Compte
    </button>
  </div>
</div>

<!-- ============================================================ -->
<!-- PRODUCT DETAIL MODAL -->
<!-- ============================================================ -->
<div class="modal-overlay" id="productModal">
  <div class="modal-sheet">
    <div class="modal-handle" onclick="closeModal()"></div>
    <img class="detail-img" id="detailImg" src="" alt="">
    <div class="detail-body">
      <div class="detail-name" id="detailName"></div>
      <div class="detail-desc" id="detailDesc"></div>

      <div class="detail-stats">
        <div class="detail-stat">
          <div class="detail-stat-value" id="detailCost">-</div>
          <div class="detail-stat-label">Co√ªt fournisseur</div>
        </div>
        <div class="detail-stat">
          <div class="detail-stat-value" id="detailShipping">-</div>
          <div class="detail-stat-label">Livraison</div>
        </div>
        <div class="detail-stat">
          <div class="detail-stat-value" id="detailScore">-</div>
          <div class="detail-stat-label">Score tendance</div>
        </div>
      </div>

      <div class="price-section">
        <div class="price-row">
          <span class="price-label">Votre prix de vente</span>
          <span class="price-value" id="priceDisplay">‚Ç¨0.00</span>
        </div>
        <input type="range" class="price-slider" id="priceSlider" min="0" max="100" value="50" oninput="updatePrice()">
        <div class="margin-info">
          <span>Marge: <strong id="marginDisplay">‚Ç¨0.00</strong></span>
          <span id="marginPct">0%</span>
        </div>
      </div>

      <button class="btn-launch" id="btnLaunch" onclick="launchStore()">
        Cr√©er ma boutique ‚Üí
      </button>
    </div>
  </div>
</div>

<!-- ============================================================ -->
<!-- SUCCESS OVERLAY -->
<!-- ============================================================ -->
<div class="success-overlay" id="successOverlay">
  <div class="success-card">
    <div class="success-icon">üéâ</div>
    <div class="success-title">Boutique cr√©√©e !</div>
    <div class="success-url" id="successUrl" onclick="copyStoreUrl()"></div>
    <div class="success-actions">
      <button class="btn-launch" onclick="window.open(document.getElementById('successUrl').dataset.url,'_blank')">Voir ma boutique</button>
      <button class="btn-sm" style="width:100%;padding:12px;text-align:center;" onclick="shareStore()">Partager</button>
      <button class="btn-sm" style="width:100%;padding:12px;text-align:center;" onclick="closeSuccess()">Retour au catalogue</button>
    </div>
  </div>
</div>

<!-- ============================================================ -->
<!-- SHARE MODAL -->
<!-- ============================================================ -->
<div class="modal-overlay" id="shareModal">
  <div class="modal-sheet" style="padding:20px;">
    <div class="modal-handle" onclick="closeShare()"></div>
    <div style="font-size:1.1rem;font-weight:700;margin-bottom:16px;">Partager votre boutique</div>
    <div class="share-platforms" id="sharePlatforms"></div>
    <div style="margin-top:12px;">
      <div style="font-size:0.78rem;color:var(--text3);margin-bottom:6px;">Lien direct</div>
      <div class="success-url" id="shareUrl" onclick="copyShareLink()" style="margin:0;"></div>
    </div>
  </div>
</div>

<!-- ============================================================ -->
<!-- CONTENT AI MODAL -->
<!-- ============================================================ -->
<div class="modal-overlay" id="contentModal">
  <div class="modal-sheet" style="padding:20px;">
    <div class="modal-handle" onclick="closeContent()"></div>
    <div style="font-size:1.1rem;font-weight:700;margin-bottom:4px;">Contenu marketing AI</div>
    <div style="font-size:0.82rem;color:var(--text2);margin-bottom:14px;">G√©n√©r√© pour votre produit</div>
    <div class="content-tabs" id="contentTabs"></div>
    <div id="contentResult"></div>
  </div>
</div>

<!-- ============================================================ -->
<!-- ANALYTICS MODAL -->
<!-- ============================================================ -->
<div class="modal-overlay" id="analyticsModal">
  <div class="modal-sheet" style="padding:20px;">
    <div class="modal-handle" onclick="closeAnalytics()"></div>
    <div style="font-size:1.1rem;font-weight:700;margin-bottom:14px;">Analytiques</div>
    <div id="analyticsContent"></div>
  </div>
</div>

<!-- ============================================================ -->
<!-- JAVASCRIPT -->
<!-- ============================================================ -->
<script>
const API = '/api';
let products = [];
let currentUser = localStorage.getItem('do_email') || '';
let currentUserMeta = JSON.parse(localStorage.getItem('do_user_meta') || 'null');
let selectedProduct = null;
let supabaseClient = null;
let lastCreatedSlug = '';

// ---------------------------------------------------------------------------
// AUTH ‚Äî Supabase + Google OAuth
// ---------------------------------------------------------------------------
async function initSupabase() {
  let cfg = null;
  try {
    const res = await fetch(`${API}/config`);
    cfg = await res.json();
    if (cfg.supabase_url && cfg.supabase_anon_key && window.supabase) {
      supabaseClient = window.supabase.createClient(cfg.supabase_url, cfg.supabase_anon_key);
      supabaseClient.auth.onAuthStateChange((event, session) => {
        if (event === 'SIGNED_IN' && session?.user) {
          handleAuthUser(session.user);
        }
      });
    }
  } catch(e) {
    console.warn('Config fetch failed');
  }
  // Hide Google button only if Supabase not available
  if (!supabaseClient) {
    const btn = document.getElementById('btnGoogle');
    if (btn) btn.style.display = 'none';
  }
}

function handleAuthUser(user) {
  const meta = user.user_metadata || {};
  currentUser = user.email;
  currentUserMeta = {
    name: meta.full_name || meta.name || user.email.split('@')[0],
    avatar: meta.avatar_url || meta.picture || '',
    provider: user.app_metadata?.provider || 'email',
  };
  localStorage.setItem('do_email', currentUser);
  localStorage.setItem('do_user_meta', JSON.stringify(currentUserMeta));
  updateProfileUI();
  showApp();
}

function updateProfileUI() {
  const el = (id) => document.getElementById(id);
  el('profileEmail').textContent = currentUser;
  if (currentUserMeta?.name) {
    el('profileName').textContent = currentUserMeta.name;
  }
  if (currentUserMeta?.avatar) {
    el('profileAvatar').src = currentUserMeta.avatar;
    el('profileAvatar').style.display = 'block';
    el('avatarContent').innerHTML = `<img src="${currentUserMeta.avatar}" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">`;
  } else {
    el('avatarContent').textContent = currentUser ? currentUser[0].toUpperCase() : 'üë§';
  }
  const prov = currentUserMeta?.provider === 'google' ? 'Connect√© via Google' : 'Connect√© par email';
  el('profileProvider').textContent = prov;
}

async function loginWithGoogle() {
  if (!supabaseClient) {
    loginWithEmail();
    return;
  }
  try {
    const { error } = await supabaseClient.auth.signInWithOAuth({
      provider: 'google',
      options: { redirectTo: window.location.origin + '/app' },
    });
    if (error) throw error;
  } catch(e) {
    console.error('Google login error:', e);
    alert('Erreur de connexion Google. Essayez avec un email.');
  }
}

function loginWithEmail() {
  const email = prompt("Entrez votre email professionnel :");
  if (!email || !email.includes('@')) return;
  currentUser = email.toLowerCase().trim();
  currentUserMeta = { name: email.split('@')[0], avatar: '', provider: 'email' };
  localStorage.setItem('do_email', currentUser);
  localStorage.setItem('do_user_meta', JSON.stringify(currentUserMeta));
  // Register user in backend
  fetch(`${API}/auth/register`, {method:'POST',headers:{'Content-Type':'application/json'},
    body:JSON.stringify({email:currentUser})}).catch(()=>{});
  updateProfileUI();
  showApp();
}

async function logout() {
  if (supabaseClient) {
    try { await supabaseClient.auth.signOut(); } catch(e){}
  }
  currentUser = '';
  currentUserMeta = null;
  localStorage.removeItem('do_email');
  localStorage.removeItem('do_user_meta');
  document.getElementById('loginScreen').classList.remove('hidden');
  document.getElementById('mainApp').style.display = 'none';
}

function showApp() {
  document.getElementById('loginScreen').classList.add('hidden');
  document.getElementById('mainApp').style.display = 'flex';
  loadProducts();
}

// ---------------------------------------------------------------------------
// INIT
// ---------------------------------------------------------------------------
async function init() {
  await initSupabase();

  if (supabaseClient) {
    try {
      const { data: { session } } = await supabaseClient.auth.getSession();
      if (session?.user) {
        handleAuthUser(session.user);
        return;
      }
    } catch(e) {}
  }

  if (currentUser) {
    updateProfileUI();
    showApp();
  }
  // else: stay on login screen
}

// ---------------------------------------------------------------------------
// NAV
// ---------------------------------------------------------------------------
function switchTab(tab, el) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.getElementById(`screen-${tab}`).classList.add('active');
  if (el) el.classList.add('active');
  if (tab === 'stores') loadUserStores();
  if (tab === 'orders') loadOrders();
  if (tab === 'network') loadNetwork();
  if (tab === 'profile') loadSellerBalance();
}

// ---------------------------------------------------------------------------
// PRODUCTS
// ---------------------------------------------------------------------------
let activeCategory = 'all';

async function loadProducts() {
  try {
    const res = await fetch(`${API}/products`);
    const data = await res.json();
    products = data.products || [];
  } catch(e) {
    products = [];
  }
  renderCategories();
  renderProducts();
}

function renderCategories() {
  const cats = ['all', ...new Set(products.map(p => p.category))].sort();
  const labels = {all:'Tous', tech:'Tech', beauty:'Beaut√©', home:'Maison', fitness:'Fitness',
    fashion:'Mode', kitchen:'Cuisine', pet:'Animaux', outdoor:'Plein air', wellness:'Bien-√™tre',
    kids:'Enfants', office:'Bureau', auto:'Auto'};
  document.getElementById('catScroll').innerHTML = cats.map(c =>
    `<button class="cat-pill ${c===activeCategory?'active':''}" onclick="filterCategory('${c}')">${labels[c]||c}</button>`
  ).join('');
}

function filterCategory(cat) {
  activeCategory = cat;
  renderCategories();
  renderProducts();
}

function filterProducts() {
  renderProducts();
}

function renderProducts() {
  const q = document.getElementById('searchInput').value.toLowerCase();
  let filtered = products;
  if (activeCategory !== 'all') filtered = filtered.filter(p => p.category === activeCategory);
  if (q) filtered = filtered.filter(p => p.name.toLowerCase().includes(q) || p.short_desc.toLowerCase().includes(q));

  document.getElementById('productGrid').innerHTML = filtered.length ? filtered.map(p => `
    <div class="product-card" onclick='openProduct(${JSON.stringify(p).replace(/'/g,"&#39;")})'>
      <img class="product-img" src="${p.images?.[0] || ''}" alt="${p.name}" loading="lazy">
      <div class="product-info">
        <div class="product-name">${p.name}</div>
        <div class="product-price">‚Ç¨${p.suggested_price.toFixed(2)}</div>
        <div class="product-margin">Marge ${p.margin_pct}% ¬∑ ${p.shipping_time}</div>
        <div class="product-tags">
          ${(p.tags||[]).slice(0,2).map(t => `<span class="product-tag">${t}</span>`).join('')}
        </div>
      </div>
    </div>
  `).join('') : '<div class="empty-state" style="grid-column:1/-1;"><div class="empty-icon">üîç</div><div class="empty-text">Aucun produit trouv√©</div></div>';
}

// ---------------------------------------------------------------------------
// PRODUCT DETAIL
// ---------------------------------------------------------------------------
function openProduct(product) {
  selectedProduct = product;
  document.getElementById('detailImg').src = product.images?.[0] || '';
  document.getElementById('detailName').textContent = product.name;
  document.getElementById('detailDesc').textContent = product.short_desc;
  document.getElementById('detailCost').textContent = `‚Ç¨${product.cost.toFixed(2)}`;
  document.getElementById('detailShipping').textContent = product.shipping_time;
  document.getElementById('detailScore').textContent = `${product.trending_score}/100`;

  const slider = document.getElementById('priceSlider');
  const min = Math.ceil(product.cost * 1.5);
  const max = Math.ceil(product.cost * 5);
  slider.min = min;
  slider.max = max;
  slider.value = product.suggested_price;
  updatePrice();

  document.getElementById('productModal').classList.add('open');
  document.getElementById('btnLaunch').disabled = false;
  document.getElementById('btnLaunch').textContent = 'Cr√©er ma boutique ‚Üí';
}

function closeModal() {
  document.getElementById('productModal').classList.remove('open');
}

function updatePrice() {
  if (!selectedProduct) return;
  const price = parseFloat(document.getElementById('priceSlider').value);
  const cost = selectedProduct.cost;
  const commission = price * 0.08;
  const margin = price - cost - commission;
  const pct = Math.round(margin / price * 100);

  document.getElementById('priceDisplay').textContent = `‚Ç¨${price.toFixed(2)}`;
  document.getElementById('marginDisplay').textContent = `‚Ç¨${margin.toFixed(2)}`;
  document.getElementById('marginPct').textContent = `${pct}%`;
}

// ---------------------------------------------------------------------------
// STORE CREATION
// ---------------------------------------------------------------------------
async function launchStore() {
  if (!currentUser) { loginWithEmail(); return; }
  if (!selectedProduct) return;

  const btn = document.getElementById('btnLaunch');
  btn.disabled = true;
  btn.textContent = 'Cr√©ation en cours...';

  const price = parseFloat(document.getElementById('priceSlider').value);

  try {
    const res = await fetch(`${API}/stores/create`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        product_id: selectedProduct.id,
        user_email: currentUser,
        custom_price: price,
      }),
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.detail || 'Erreur');

    lastCreatedSlug = data.slug;
    const url = `${window.location.origin}/s/${data.slug}`;
    document.getElementById('successUrl').textContent = url;
    document.getElementById('successUrl').dataset.url = url;

    closeModal();
    document.getElementById('successOverlay').classList.add('open');
  } catch(e) {
    alert('Erreur: ' + e.message);
    btn.disabled = false;
    btn.textContent = 'Cr√©er ma boutique ‚Üí';
  }
}

function copyStoreUrl() {
  const url = document.getElementById('successUrl').dataset.url;
  navigator.clipboard.writeText(url).then(() => {
    document.getElementById('successUrl').textContent = '‚úÖ Copi√© !';
    setTimeout(() => document.getElementById('successUrl').textContent = url, 2000);
  });
}

function closeSuccess() {
  document.getElementById('successOverlay').classList.remove('open');
  switchTab('stores', document.querySelectorAll('.tab')[2]);
}

// ---------------------------------------------------------------------------
// USER STORES
// ---------------------------------------------------------------------------
async function loadUserStores() {
  const el = document.getElementById('storesContent');
  if (!currentUser) {
    el.innerHTML = '<div class="empty-state"><div class="empty-icon">üè™</div><div class="empty-text">Connectez-vous pour voir vos boutiques</div></div>';
    return;
  }
  el.innerHTML = '<div class="spinner"></div>';

  try {
    const res = await fetch(`${API}/user/${encodeURIComponent(currentUser)}/stores`);
    const data = await res.json();
    const stores = data.stores || [];
    const archived = data.archived || [];

    if (!stores.length && !archived.length) {
      el.innerHTML = '<div class="empty-state"><div class="empty-icon">üè™</div><div class="empty-text">Aucune boutique. Cr√©ez votre premi√®re depuis le catalogue !</div></div>';
      return;
    }

    let html = '';

    // Active stores counter
    if (stores.length) {
      html += `<div style="color:var(--text3);font-size:0.8rem;margin-bottom:10px">${stores.length}/${data.max_stores||10} boutiques actives</div>`;
      html += stores.map(s => renderStoreCard(s, false)).join('');
    }

    // Archived stores section
    if (archived.length) {
      html += `<div style="margin-top:20px;padding-top:14px;border-top:1px solid var(--border)">
        <div style="color:var(--text3);font-size:0.8rem;margin-bottom:10px;cursor:pointer" onclick="this.nextElementSibling.style.display=this.nextElementSibling.style.display==='none'?'block':'none'">
          üì¶ Historique (${archived.length} archiv√©e${archived.length>1?'s':''}) ‚ñæ
        </div>
        <div style="display:none">
          ${archived.map(s => renderStoreCard(s, true)).join('')}
        </div>
      </div>`;
    }

    el.innerHTML = html;
  } catch(e) {
    el.innerHTML = '<div class="empty-state"><div class="empty-text">Erreur de chargement</div></div>';
  }
}

function renderStoreCard(s, isArchived) {
  const p = s.product_data || {};
  const active = s.active !== false && !isArchived;
  return `
    <div class="store-card" style="${isArchived?'opacity:0.7':''}">
      <div class="store-header">
        <div>
          <div class="store-name">${s.store_name || p.name || 'Boutique'}</div>
          <div class="store-meta">${p.name || ''} ¬∑ ‚Ç¨${parseFloat(s.seller_price||0).toFixed(2)}</div>
        </div>
        <span class="store-status ${isArchived?'inactive':active?'active':'inactive'}">${isArchived?'Archiv√©e':active?'Active':'Inactive'}</span>
      </div>
      <div class="store-stats">
        <div><span class="store-stat-num">${s.total_sales||0}</span><span class="store-stat-label">ventes</span></div>
        <div><span class="store-stat-num">‚Ç¨${parseFloat(s.total_revenue||0).toFixed(2)}</span><span class="store-stat-label">revenus</span></div>
      </div>
      <div class="store-actions">
        <button class="btn-sm primary" onclick="window.open('/s/${s.slug}','_blank')">Voir</button>
        ${isArchived ? `
          <button class="btn-sm" onclick="unarchiveStore('${s.slug}')">Restaurer</button>
          <button class="btn-sm" style="color:var(--red)" onclick="deleteStore('${s.slug}')">Supprimer</button>
        ` : `
          <button class="btn-sm" onclick="openShareForSlug('${s.slug}')">Partager</button>
          <button class="btn-sm" onclick="openAnalytics('${s.slug}')">Stats</button>
          <button class="btn-sm" onclick="openContentForSlug('${s.slug}')">Contenu AI</button>
          <button class="btn-sm" onclick="toggleStore('${s.slug}')">${active?'D√©sactiver':'Activer'}</button>
          <button class="btn-sm" onclick="archiveStore('${s.slug}')">Archiver</button>
        `}
      </div>
    </div>`;
}

async function toggleStore(slug) {
  try {
    await fetch(`${API}/stores/${slug}/toggle`, {
      method: 'PUT',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({email: currentUser}),
    });
    loadUserStores();
  } catch(e) {}
}

async function archiveStore(slug) {
  if (!confirm('Archiver cette boutique ? Elle restera accessible via son lien.')) return;
  try {
    await fetch(`${API}/stores/${slug}/archive`, {
      method: 'PUT',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({email: currentUser}),
    });
    loadUserStores();
  } catch(e) { alert('Erreur: ' + e.message); }
}

async function unarchiveStore(slug) {
  try {
    const res = await fetch(`${API}/stores/${slug}/unarchive`, {
      method: 'PUT',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({email: currentUser}),
    });
    if (!res.ok) {
      const d = await res.json();
      alert(d.detail || 'Erreur');
      return;
    }
    loadUserStores();
  } catch(e) { alert('Erreur: ' + e.message); }
}

async function deleteStore(slug) {
  if (!confirm('‚ö†Ô∏è Supprimer d√©finitivement cette boutique ?')) return;
  if (!confirm('Cette action est irr√©versible. Confirmer ?')) return;
  try {
    await fetch(`${API}/stores/${slug}`, {
      method: 'DELETE',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({email: currentUser}),
    });
    loadUserStores();
  } catch(e) { alert('Erreur: ' + e.message); }
}

// ---------------------------------------------------------------------------
// ORDERS
// ---------------------------------------------------------------------------
async function loadOrders() {
  const el = document.getElementById('ordersContent');
  if (!currentUser) {
    el.innerHTML = '<div class="empty-state"><div class="empty-icon">üì¶</div><div class="empty-text">Connectez-vous pour voir vos commandes</div></div>';
    return;
  }
  el.innerHTML = '<div class="spinner"></div>';

  try {
    const res = await fetch(`${API}/user/${encodeURIComponent(currentUser)}/orders`);
    const data = await res.json();
    const orders = data.orders || [];
    const stats = data.stats || {};
    if (!orders.length) {
      el.innerHTML = '<div class="empty-state"><div class="empty-icon">üì¶</div><div class="empty-text">Aucune commande pour le moment</div></div>';
      return;
    }

    const statusLabels = {
      pending:'‚è≥ En attente', processing:'üì¶ En cours', shipped:'üöö Exp√©di√©',
      delivered:'‚úÖ Livr√©', paid:'üí≥ Pay√©', cj_failed:'‚ö†Ô∏è Erreur fournisseur'
    };

    let html = `<div style="color:var(--text3);font-size:0.8rem;margin-bottom:10px">
      ${stats.total_orders||0} commandes ¬∑ ‚Ç¨${(stats.total_margin||0).toFixed(2)} de marge
    </div>`;

    html += orders.map(o => {
      const statusClass = o.status === 'shipped' ? 'shipped' : o.status === 'delivered' ? 'delivered' : o.status === 'cj_failed' ? 'failed' : 'pending';
      const statusLabel = statusLabels[o.status] || o.status;
      const date = o.created_at ? new Date(o.created_at).toLocaleDateString('fr-FR') : '';
      return `
        <div class="order-card">
          <div class="order-top">
            <span class="order-id">${o.order_id}</span>
            <span class="order-status ${statusClass}">${statusLabel}</span>
          </div>
          <div class="order-details">
            ${o.product_name || 'Produit'} ¬∑ ${date}
            ${o.customer_name ? ` ¬∑ ${o.customer_name}` : ''}
            ${o.tracking_number ? `<br>üîó Tracking: <a href="https://t.17track.net/en#nums=${o.tracking_number}" target="_blank" style="color:var(--accent)">${o.tracking_number}</a>` : ''}
            ${o.status === 'cj_failed' ? `<br><span style="color:var(--red);font-size:0.75rem">${o.error || 'Erreur ‚Äî contactez le support'}</span>` : ''}
          </div>
          <div class="order-amount">+‚Ç¨${parseFloat(o.seller_margin||0).toFixed(2)}</div>
        </div>`;
    }).join('');

    el.innerHTML = html;
  } catch(e) {
    el.innerHTML = '<div class="empty-state"><div class="empty-text">Erreur de chargement</div></div>';
  }
}

// ---------------------------------------------------------------------------
// NETWORK
// ---------------------------------------------------------------------------
async function loadNetwork() {
  const el = document.getElementById('networkContent');
  el.innerHTML = '<div class="spinner"></div>';

  try {
    const [trending, sources, leaderboard, profile] = await Promise.all([
      fetch(`${API}/network/trending`).then(r=>r.json()).catch(()=>[]),
      fetch(`${API}/network/sources`).then(r=>r.json()).catch(()=>[]),
      fetch(`${API}/network/leaderboard`).then(r=>r.json()).catch(()=>[]),
      currentUser ? fetch(`${API}/network/profile/${encodeURIComponent(currentUser)}`).then(r=>r.json()).catch(()=>null) : null,
    ]);

    let html = '';

    // Seller level
    if (profile) {
      html += `<div class="network-card">
        <div class="network-card-title">üèÜ Votre niveau</div>
        <div style="display:flex;align-items:center;gap:12px;">
          <div style="font-size:1.8rem;">${profile.level_name?.split(' ')[0] || 'üå±'}</div>
          <div>
            <div style="font-weight:700;">${profile.level_name || 'D√©butant'}</div>
            <div style="font-size:0.78rem;color:var(--text2);">Niveau ${profile.level} ¬∑ ${profile.xp} XP</div>
            <div style="margin-top:4px;height:4px;background:var(--border);border-radius:2px;overflow:hidden;">
              <div style="height:100%;width:${profile.progress_pct||0}%;background:var(--accent);border-radius:2px;"></div>
            </div>
          </div>
        </div>
      </div>`;
    }

    // Trending products
    const trendItems = (trending || []).slice(0, 8);
    if (trendItems.length) {
      html += `<div class="network-card">
        <div class="network-card-title">üî• Produits tendance</div>
        ${trendItems.map((t,i) => `
          <div class="trend-item">
            <span class="trend-rank">#${i+1}</span>
            <span class="trend-name">${t.product_name}</span>
            <span class="trend-sales">${t.sales_count} ventes</span>
          </div>
        `).join('')}
      </div>`;
    }

    // Leaderboard
    const leaders = (leaderboard || []).slice(0, 10);
    if (leaders.length) {
      html += `<div class="network-card">
        <div class="network-card-title">üèÖ Classement vendeurs</div>
        ${leaders.map(l => `
          <div class="trend-item">
            <span class="trend-rank">#${l.rank}</span>
            <span class="trend-name">${l.display_name} <span style="font-size:0.72rem;color:var(--text3);">${l.level_name}</span></span>
            <span style="font-size:0.8rem;color:var(--accent);font-weight:700;">${l.xp} XP</span>
          </div>
        `).join('')}
      </div>`;
    }

    el.innerHTML = html || '<div class="empty-state"><div class="empty-icon">üìä</div><div class="empty-text">Les donn√©es r√©seau appara√Ætront apr√®s les premi√®res ventes</div></div>';
  } catch(e) {
    el.innerHTML = '<div class="empty-state"><div class="empty-text">Erreur de chargement</div></div>';
  }
}

// ---------------------------------------------------------------------------
// SELLER PAYMENTS
// ---------------------------------------------------------------------------
async function loadSellerBalance() {
  if (!currentUser) return;
  try {
    const res = await fetch(`${API}/seller/balance/${encodeURIComponent(currentUser)}`);
    const data = await res.json();
    document.getElementById('sellerBalance').textContent = `‚Ç¨${(data.balance||0).toFixed(2)}`;
    document.getElementById('sellerTotalEarned').textContent = `‚Ç¨${(data.total_earned||0).toFixed(2)}`;
    document.getElementById('sellerTotalWithdrawn').textContent = `‚Ç¨${(data.total_withdrawn||0).toFixed(2)}`;

    if (data.stripe_connected) {
      document.getElementById('stripeStatus').textContent = '‚úÖ Connect√©';
      document.getElementById('stripeStatus').style.color = 'var(--green)';
      document.getElementById('stripeConnectBtn').textContent = 'Dashboard';
      document.getElementById('stripeConnectBtn').onclick = openStripeDashboard;
    }
    if (data.paypal_email) {
      document.getElementById('paypalEmailInput').value = data.paypal_email;
      document.getElementById('paypalStatus').textContent = '‚úÖ ' + data.paypal_email;
      document.getElementById('paypalStatus').style.color = 'var(--green)';
    }
    loadPayoutHistory();
  } catch(e) {}
}

async function connectStripe() {
  if (!currentUser) return;
  try {
    const res = await fetch(`${API}/seller/connect-stripe`, {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({email:currentUser}),
    });
    const data = await res.json();
    if (data.onboarding_url) window.open(data.onboarding_url, '_blank');
    else if (data.detail) alert(data.detail);
  } catch(e) { alert('Erreur: ' + e.message); }
}

async function openStripeDashboard() {
  try {
    const res = await fetch(`${API}/seller/stripe-dashboard/${encodeURIComponent(currentUser)}`);
    const data = await res.json();
    if (data.dashboard_url) window.open(data.dashboard_url, '_blank');
  } catch(e) {}
}

async function savePaypalEmail() {
  const paypalEmail = document.getElementById('paypalEmailInput').value.trim();
  if (!paypalEmail || !paypalEmail.includes('@')) { alert('Email PayPal invalide'); return; }
  try {
    const res = await fetch(`${API}/seller/set-paypal`, {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({email:currentUser, paypal_email:paypalEmail}),
    });
    if (res.ok) {
      document.getElementById('paypalStatus').textContent = '‚úÖ ' + paypalEmail;
      document.getElementById('paypalStatus').style.color = 'var(--green)';
    } else {
      const d = await res.json();
      alert(d.detail || 'Erreur');
    }
  } catch(e) { alert('Erreur: ' + e.message); }
}

async function requestWithdrawal() {
  if (!currentUser) return;
  const bal = parseFloat(document.getElementById('sellerBalance').textContent.replace('‚Ç¨','')) || 0;
  if (bal < 10) { alert(`Solde insuffisant (‚Ç¨${bal.toFixed(2)}). Minimum : ‚Ç¨10.00`); return; }
  const amount = prompt(`Montant √† retirer (min ‚Ç¨10, max ‚Ç¨${bal.toFixed(2)}) :`);
  if (!amount) return;
  const num = parseFloat(amount);
  if (isNaN(num) || num < 10 || num > bal) { alert('Montant invalide'); return; }
  if (!confirm(`Confirmer le retrait de ‚Ç¨${num.toFixed(2)} ?`)) return;

  try {
    const res = await fetch(`${API}/seller/withdraw`, {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({email:currentUser, amount:num}),
    });
    const data = await res.json();
    if (res.ok) {
      alert(`‚úÖ Retrait de ‚Ç¨${num.toFixed(2)} effectu√© via ${data.method}`);
      loadSellerBalance();
    } else { alert(data.detail || 'Erreur'); }
  } catch(e) { alert('Erreur: ' + e.message); }
}

async function loadPayoutHistory() {
  try {
    const res = await fetch(`${API}/seller/payouts/${encodeURIComponent(currentUser)}`);
    const data = await res.json();
    const payouts = data.payouts || [];
    const el = document.getElementById('payoutHistory');
    if (!payouts.length) { el.textContent = 'Aucun retrait pour le moment'; return; }
    el.innerHTML = payouts.slice(0,10).map(p => {
      const date = new Date(p.created_at).toLocaleDateString('fr-FR');
      const icon = p.status==='completed'?'‚úÖ':p.status==='failed'?'‚ùå':'‚è≥';
      return `<div class="payout-item"><span>${icon} ‚Ç¨${parseFloat(p.amount).toFixed(2)} ¬∑ ${p.method}</span><span style="color:var(--text3)">${date}</span></div>`;
    }).join('');
  } catch(e) {}
}

// ---------------------------------------------------------------------------
// SHARE
// ---------------------------------------------------------------------------
function shareStore() {
  if (lastCreatedSlug) openShareForSlug(lastCreatedSlug);
}

async function openShareForSlug(slug) {
  try {
    const res = await fetch(`${API}/share/${slug}`);
    const data = await res.json();
    const url = data.copy_link || `${window.location.origin}/s/${slug}`;
    const p = data.platforms || {};

    document.getElementById('shareUrl').textContent = url;
    document.getElementById('shareUrl').dataset.url = url;

    document.getElementById('sharePlatforms').innerHTML = `
      <button class="share-btn" onclick="window.open('${p.whatsapp?.share_url||''}','_blank')">üí¨ WhatsApp</button>
      <button class="share-btn" onclick="window.open('${p.facebook?.share_url||''}','_blank')">üìò Facebook</button>
      <button class="share-btn" onclick="copyShareLink()">üìã Copier le lien</button>
      <button class="share-btn" onclick="openContentForSlug('${slug}');closeShare();">ü§ñ Contenu AI</button>
    `;
    document.getElementById('shareModal').classList.add('open');
  } catch(e) {}
}

function closeShare() { document.getElementById('shareModal').classList.remove('open'); }

function copyShareLink() {
  const url = document.getElementById('shareUrl').dataset.url;
  navigator.clipboard.writeText(url).then(() => {
    document.getElementById('shareUrl').textContent = '‚úÖ Copi√© !';
    setTimeout(() => document.getElementById('shareUrl').textContent = url, 2000);
  });
}

// ---------------------------------------------------------------------------
// CONTENT AI
// ---------------------------------------------------------------------------
let currentContentSlug = '';

async function openContentForSlug(slug) {
  currentContentSlug = slug;
  const platforms = ['tiktok','instagram','facebook','snapchat'];
  document.getElementById('contentTabs').innerHTML = platforms.map((p,i) =>
    `<button class="content-tab ${i===0?'active':''}" onclick="loadContent('${slug}','${p}',this)">${{tiktok:'üéµ TikTok',instagram:'üì∏ Instagram',facebook:'üìò Facebook',snapchat:'üëª Snapchat'}[p]}</button>`
  ).join('');
  document.getElementById('contentResult').innerHTML = '<div class="spinner"></div>';
  document.getElementById('contentModal').classList.add('open');
  loadContent(slug, 'tiktok');
}

async function loadContent(slug, platform, btn) {
  if (btn) {
    document.querySelectorAll('.content-tab').forEach(t=>t.classList.remove('active'));
    btn.classList.add('active');
  }
  document.getElementById('contentResult').innerHTML = '<div class="spinner"></div>';
  try {
    const res = await fetch(`${API}/content/${slug}/${platform}`);
    const data = await res.json();
    const text = data.script || data.caption || data.content || JSON.stringify(data, null, 2);
    document.getElementById('contentResult').innerHTML = `
      <div class="content-result">${text.replace(/\n/g,'<br>')}</div>
      <button class="btn-copy" onclick="navigator.clipboard.writeText(\`${text.replace(/`/g,'\\`').replace(/\\/g,'\\\\')}\`);this.textContent='‚úÖ Copi√© !';">üìã Copier</button>
    `;
  } catch(e) {
    document.getElementById('contentResult').innerHTML = '<div class="empty-state"><div class="empty-text">Erreur de g√©n√©ration</div></div>';
  }
}

function closeContent() { document.getElementById('contentModal').classList.remove('open'); }

// ---------------------------------------------------------------------------
// ANALYTICS
// ---------------------------------------------------------------------------
async function openAnalytics(slug) {
  document.getElementById('analyticsContent').innerHTML = '<div class="spinner"></div>';
  document.getElementById('analyticsModal').classList.add('open');

  try {
    const res = await fetch(`${API}/analytics/${slug}?period=7d`);
    const data = await res.json();
    document.getElementById('analyticsContent').innerHTML = `
      <div class="analytics-grid">
        <div class="analytics-card">
          <div class="analytics-value">${data.total_views||0}</div>
          <div class="analytics-label">Vues (7j)</div>
        </div>
        <div class="analytics-card">
          <div class="analytics-value">${data.total_conversions||0}</div>
          <div class="analytics-label">Conversions</div>
        </div>
        <div class="analytics-card">
          <div class="analytics-value">‚Ç¨${(data.total_revenue||0).toFixed(2)}</div>
          <div class="analytics-label">Revenus</div>
        </div>
        <div class="analytics-card">
          <div class="analytics-value">${(data.conversion_rate||0).toFixed(1)}%</div>
          <div class="analytics-label">Taux conv.</div>
        </div>
      </div>
      <div class="network-card" style="margin:0;">
        <div class="network-card-title">Sources de trafic</div>
        ${Object.entries(data.sources||{}).map(([s,v]) =>
          `<div class="trend-item"><span class="trend-name">${s}</span><span style="font-weight:700;">${v}</span></div>`
        ).join('') || '<div style="font-size:0.82rem;color:var(--text3);">Aucune donn√©e</div>'}
      </div>
    `;
  } catch(e) {
    document.getElementById('analyticsContent').innerHTML = '<div class="empty-state"><div class="empty-text">Erreur de chargement</div></div>';
  }
}

function closeAnalytics() { document.getElementById('analyticsModal').classList.remove('open'); }

// ---------------------------------------------------------------------------
// CLICK OUTSIDE TO CLOSE MODALS
// ---------------------------------------------------------------------------
document.addEventListener('click', (e) => {
  if (e.target.classList.contains('modal-overlay')) {
    e.target.classList.remove('open');
  }
});

// ---------------------------------------------------------------------------
// START
// ---------------------------------------------------------------------------
init();
</script>
</body>
</html>
